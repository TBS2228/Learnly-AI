<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learnly AI</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e1b4b; /* Indigo-950 */
            color: #e0e7ff; /* Indigo-100 */
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div class="bg-[#312e81] rounded-2xl shadow-2xl p-8 md:p-12 w-full max-w-4xl flex flex-col gap-8">
        
        <!-- Header and Logo -->
        <header class="text-center flex flex-col items-center">
            <h1 class="text-4xl md:text-5xl font-bold text-[#8b5cf6] mb-2">
                Learnly AI
            </h1>
            <p class="text-indigo-200">
                Smarter Learning, Better Future
            </p>
            <!-- User ID is hidden but functional -->
            <p class="text-sm mt-4 text-indigo-300 hidden">
              <span id="user-id-display"></span>
            </p>
        </header>

        <!-- Quiz Generation Form -->
        <div id="quiz-form" class="flex flex-col gap-6">
            <div class="flex flex-col gap-4">
                <textarea id="topic-input" class="w-full h-32 bg-indigo-900 border-2 border-indigo-700 rounded-xl p-4 text-indigo-100 placeholder-indigo-500 focus:outline-none focus:ring-2 focus:ring-[#8b5cf6] resize-none transition-colors duration-200" placeholder="Enter a topic, like 'The life cycle of a butterfly' or 'The history of the Roman Empire'"></textarea>
                
                <div class="flex items-center gap-4 text-indigo-300">
                    <hr class="flex-grow border-indigo-700">
                    <span>or</span>
                    <hr class="flex-grow border-indigo-700">
                </div>
                <label for="file-input" class="w-full text-center bg-indigo-900 border-2 border-indigo-700 rounded-xl p-4 text-indigo-100 placeholder-indigo-500 focus:outline-none focus:ring-2 focus:ring-[#8b5cf6] transition-colors duration-200 cursor-pointer hover:bg-indigo-800">
                    <span id="file-label">Upload a JPEG or PNG image file</span>
                    <input type="file" id="file-input" class="hidden" accept="image/jpeg, image/png">
                </label>
            </div>

            <div class="flex flex-col sm:flex-row gap-4">
                <select id="difficulty-select" class="w-full sm:w-1/4 bg-indigo-900 border-2 border-indigo-700 rounded-xl p-3 text-indigo-100 focus:outline-none focus:ring-2 focus:ring-[#8b5cf6] transition-colors duration-200">
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="expert">Expert</option>
                </select>
                <select id="language-select" class="w-full sm:w-1/4 bg-indigo-900 border-2 border-indigo-700 rounded-xl p-3 text-indigo-100 focus:outline-none focus:ring-2 focus:ring-[#8b5cf6] transition-colors duration-200">
                    <option value="English">English</option>
                    <option value="Spanish">Spanish</option>
                    <option value="French">French</option>
                    <option value="German">German</option>
                    <option value="Japanese">Japanese</option>
                    <option value="Arabic">Arabic</option>
                    <option value="Chinese (Simplified)">Chinese (Simplified)</option>
                    <option value="Dutch">Dutch</option>
                    <option value="Hindi">Hindi</option>
                    <option value="Italian">Italian</option>
                    <option value="Korean">Korean</option>
                    <option value="Portuguese">Portuguese</option>
                    <option value="Russian">Russian</option>
                    <option value="Turkish">Turkish</option>
                </select>
                <input type="number" id="question-count-input" value="5" min="1" max="33" class="w-full sm:w-1/4 bg-indigo-900 border-2 border-indigo-700 rounded-xl p-3 text-indigo-100 placeholder-indigo-500 focus:outline-none focus:ring-2 focus:ring-[#8b5cf6] transition-colors duration-200" placeholder="Questions (max 33)">

                <button id="generate-button" class="w-full sm:w-1/4 bg-[#8b5cf6] text-indigo-950 font-bold py-3 rounded-xl transition-all duration-300 hover:bg-[#a78bfa] focus:outline-none focus:ring-2 focus:ring-violet-700 focus:ring-offset-2 focus:ring-offset-[#312e81] disabled:opacity-50 disabled:cursor-not-allowed">
                    Generate Quiz
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="hidden flex flex-col items-center justify-center text-center py-10">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-violet-500 border-indigo-700"></div>
            <p class="mt-4 text-indigo-300">Generating quiz, please wait...</p>
        </div>

        <!-- Quiz Display Container -->
        <div id="quiz-container" class="hidden flex flex-col gap-6">
            <!-- Questions will be dynamically inserted here -->
        </div>

        <!-- Result Display -->
        <div id="results" class="hidden flex flex-col items-center gap-4 text-center">
            <p class="text-2xl font-semibold">Quiz Complete!</p>
            <p id="score-display" class="text-4xl font-bold"></p>
            <div class="flex flex-col sm:flex-row gap-4 w-full justify-center">
                <button id="restart-button" class="bg-indigo-800 text-indigo-100 font-bold py-3 px-6 rounded-xl transition-all duration-300 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-[#312e81]">
                    Generate a new Quiz
                </button>
                <button id="download-quiz-button" class="bg-indigo-800 text-indigo-100 font-bold py-3 px-6 rounded-xl transition-all duration-300 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-[#312e81]">
                    Download Quiz
                </button>
            </div>
        </div>

        <!-- Custom Alert/Modal for Quiz Explanation -->
        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-indigo-900 rounded-xl p-8 w-full max-w-md text-center">
                <p id="modal-message" class="text-lg font-medium text-indigo-100 mb-6"></p>
                <button id="modal-close-button" class="bg-[#8b5cf6] text-indigo-950 font-bold py-2 px-6 rounded-xl transition-all duration-300 hover:bg-[#a78bfa] focus:outline-none focus:ring-2 focus:ring-violet-700">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Replace the placeholder values below with your actual Firebase project configuration.
        // You can find this in your Firebase console under Project settings -> General.
        const firebaseConfig = {
            apiKey: "AIzaSyDN39Reafuyt9clV-ISPgYKQ1r94r8LPMY",
            authDomain: "learnly-ai-547ef.firebaseapp.com",
            projectId: "learnly-ai-547ef",
            storageBucket: "learnly-ai-547ef.firebasestorage.app",
            messagingSenderId: "748289039512",
            appId: "1:748289039512:web:d1acde9acab1ed907b04ed"
        };
        const appId = firebaseConfig.projectId; // Use the project ID for the app ID in a local context
        const apiKey = 'AIzaSyDUDqNOQIr3h1lONzSVan7GFRLgWu_uQWk'; // IMPORTANT: Replace this with your actual Gemini API key.

        let app, db, auth, userId;
        const quizGenerationUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // UI elements
        const quizForm = document.getElementById('quiz-form');
        const loadingIndicator = document.getElementById('loading');
        const quizContainer = document.getElementById('quiz-container');
        const resultsContainer = document.getElementById('results');
        const scoreDisplay = document.getElementById('score-display');
        const topicInput = document.getElementById('topic-input');
        const fileInput = document.getElementById('file-input');
        const fileLabel = document.getElementById('file-label');
        const difficultySelect = document.getElementById('difficulty-select');
        const languageSelect = document.getElementById('language-select');
        const questionCountInput = document.getElementById('question-count-input');
        const generateButton = document.getElementById('generate-button');
        const restartButton = document.getElementById('restart-button');
        const downloadQuizButton = document.getElementById('download-quiz-button');
        const userIdDisplay = document.getElementById('user-id-display');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');

        let currentQuiz = [];
        let score = 0;
        let answeredQuestions = 0;

        // ðŸ› ï¸ FIX: Always hide loading & re-enable button
        function finishLoading() {
            loadingIndicator.classList.add('hidden');
            generateButton.disabled = false;
        }

        // Custom Modal
        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        function hideModal() {
            modal.classList.add('hidden');
        }
        modalCloseButton.addEventListener('click', hideModal);

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileLabel.textContent = fileInput.files[0].name;
                topicInput.value = '';
            } else {
                fileLabel.textContent = 'Upload a JPEG or PNG image file';
            }
        });
        topicInput.addEventListener('input', () => {
            if (topicInput.value.length > 0) {
                fileInput.value = '';
                fileLabel.textContent = 'Upload a JPEG or PNG image file';
            }
        });

        // Firebase Init
        const initFirebase = async () => {
          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);
          setLogLevel('debug');

          await signInAnonymously(auth);
          onAuthStateChanged(auth, (user) => {
            if (user) {
              userId = user.uid;
              userIdDisplay.textContent = `User ID: ${userId}`;
              const quizRef = collection(db, `artifacts/${appId}/users/${userId}/quizzes`);
              onSnapshot(quizRef, (snapshot) => {
              snapshot.docChanges().forEach((change) => {
                if (change.type === "added" || change.type === "modified") {
                  const newQuiz = change.doc.data().quizData;
                  if (newQuiz) {
                   currentQuiz = newQuiz;
                   renderQuiz();
                   quizForm.classList.add('hidden');
                   quizContainer.classList.remove('hidden');
                   finishLoading(); // âœ… Hide spinner after rendering
              }
            }
          });
        });
      }
    });
  };

        // Render Quiz to UI
        function renderQuiz() {
            quizContainer.innerHTML = '';
            currentQuiz.forEach((q, index) => {
                const questionElement = document.createElement('div');
                questionElement.className = 'bg-indigo-900 rounded-xl p-6 mb-4 shadow-md';
                questionElement.innerHTML = `
                    <h3 class="text-xl font-semibold mb-4">${index + 1}. ${q.question}</h3>
                    <div class="flex flex-col gap-3">
                        ${q.options.map((option, optIndex) => `
                            <button data-index="${index}" data-option="${option}" class="option-button w-full text-left bg-indigo-800 text-indigo-100 py-3 px-4 rounded-lg transition-colors duration-200 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-[#8b5cf6] disabled:opacity-50">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                `;
                quizContainer.appendChild(questionElement);
            });

            document.querySelectorAll('.option-button').forEach(button => {
                button.addEventListener('click', handleAnswer);
            });
        }

        // Handle User Answer
        function handleAnswer(event) {
            const button = event.target;
            const questionIndex = button.dataset.index;
            const selectedOption = button.dataset.option;
            const questionData = currentQuiz[questionIndex];
            const parentElement = button.closest('div.bg-indigo-900');

            if (questionData.answered) return;
            questionData.answered = true;
            answeredQuestions++;

            document.querySelectorAll(`.option-button[data-index="${questionIndex}"]`).forEach(btn => {
                btn.disabled = true;
                if (btn.dataset.option === questionData.answer) {
                    btn.classList.add('bg-green-700', 'hover:bg-green-700', 'ring-2', 'ring-green-500');
                }
                if (btn === button && selectedOption !== questionData.answer) {
                    button.classList.add('bg-red-700', 'hover:bg-red-700');
                }
            });

            if (selectedOption === questionData.answer) {
                score++;
            }

            // Add 'Explain Answer' button after a question is answered
            const explainButton = document.createElement('button');
            explainButton.textContent = 'âœ¨ Explain Answer';
            explainButton.className = 'mt-4 w-full bg-[#8b5cf6] text-indigo-950 font-bold py-3 px-6 rounded-xl transition-all duration-300 hover:bg-[#a78bfa] focus:outline-none focus:ring-2 focus:ring-violet-700';
            explainButton.addEventListener('click', () => explainAnswer(questionData.question, questionData.answer, topicInput.value));
            parentElement.appendChild(explainButton);


            if (answeredQuestions === currentQuiz.length) {
                setTimeout(showResults, 1000);
            }
        }

        function showResults() {
            quizContainer.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            scoreDisplay.textContent = `${score} / ${currentQuiz.length}`;
        }

        restartButton.addEventListener('click', () => {
            quizForm.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
            quizContainer.classList.add('hidden');
            score = 0;
            answeredQuestions = 0;
            currentQuiz = [];
        });

        // Gemini API Call
        async function generateQuiz() {
            const topic = topicInput.value.trim();
            const file = fileInput.files[0];
            const difficulty = difficultySelect.value;
            const language = languageSelect.value;
            const questionCount = parseInt(questionCountInput.value, 10);

            if (apiKey === "YOUR_GEMINI_API_KEY") {
                showModal("Please provide your Gemini API key in the code. See the comments for instructions.");
                return;
            }

            if (!topic && !file) {
                showModal("Please enter a topic or upload an image to generate a quiz.");
                return;
            }

            if (isNaN(questionCount) || questionCount < 1 || questionCount > 33) {
                showModal("Please enter a number of questions between 1 and 33.");
                return;
            }

            // UI State
            quizForm.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            generateButton.disabled = true;
            quizContainer.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            
            let quizData = null;
            let retries = 0;
            const maxRetries = 3;

            while (retries < maxRetries) {
                try {
                    let payload;
                    if (file) {
                        if (!file.type.startsWith('image/')) {
                            throw new Error("Only image files (JPEG, PNG) are supported at this time.");
                        }
                        const mimeType = file.type;
                        const data = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                            reader.readAsDataURL(file);
                        });
                        
                        const promptText = `You are an expert quiz generator. Create a ${questionCount}-question multiple-choice quiz about the content of the image provided. The quiz should be at a ${difficulty} difficulty level, in the ${language} language. The response MUST be a JSON array. Each object in the array should have 'question' (string), 'options' (an array of 4 strings), and 'answer' (the correct option string).`;
                        
                        payload = {
                            contents: [{
                                parts: [
                                    { text: promptText },
                                    { inlineData: { mimeType, data } }
                                ]
                            }],
                            generationConfig: {
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            "question": { "type": "STRING" },
                                            "options": {
                                                "type": "ARRAY",
                                                "items": { "type": "STRING" },
                                                "minItems": 4,
                                                "maxItems": 4
                                            },
                                            "answer": { "type": "STRING" }
                                        },
                                        "propertyOrdering": ["question", "options", "answer"]
                                    }
                                }
                            }
                        };
                        const response = await fetch(quizGenerationUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`API error: ${response.status} ${response.statusText} - ${errorText}`);
                        }

                        const result = await response.json();
                        const jsonString = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (jsonString) {
                            quizData = JSON.parse(jsonString);
                        } else {
                            throw new Error('No quiz data received from API');
                        }

                    } else { // topic
                        const promptText = `You are an expert quiz generator. Create a ${questionCount}-question multiple-choice quiz about '${topic}' at a ${difficulty} difficulty level, in the ${language} language. The response MUST be a JSON array. Each object in the array should have 'question' (string), 'options' (an array of 4 strings), and 'answer' (the correct option string).`;
                        
                        payload = {
                            contents: [{
                                parts: [{ text: promptText }]
                            }],
                            generationConfig: {
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            "question": { "type": "STRING" },
                                            "options": {
                                                "type": "ARRAY",
                                                "items": { "type": "STRING" },
                                                "minItems": 4,
                                                "maxItems": 4
                                            },
                                            "answer": { "type": "STRING" }
                                        },
                                        "propertyOrdering": ["question", "options", "answer"]
                                    }
                                }
                            }
                        };
                        const response = await fetch(quizGenerationUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`API error: ${response.status} ${response.statusText} - ${errorText}`);
                        }

                        const result = await response.json();
                        const jsonString = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (jsonString) {
                            quizData = JSON.parse(jsonString);
                        } else {
                            throw new Error('No quiz data received from API');
                        }
                    }
                    break;

                } catch (error) {
                    console.error("Error generating quiz:", error);
                    retries++;
                    if (retries < maxRetries) {
                        const delay = Math.pow(2, retries) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        showModal("Failed to generate quiz after multiple attempts. This is often a temporary issue with the AI service. Please wait a moment and try again.");
                        loadingIndicator.classList.add('hidden');
                        quizForm.classList.remove('hidden');
                        generateButton.disabled = false;
                        return;
                    }
                }
            }

            if (quizData && db && userId) {
                try {
                    const quizzesRef = collection(db, `artifacts/${appId}/users/${userId}/quizzes`);
                    await addDoc(quizzesRef, {
                        topic: topic || file.name,
                        difficulty,
                        language,
                        quizData,
                        createdAt: serverTimestamp(),
                        userId
                    });
                } catch (e) {
                    console.error("Error saving quiz to Firestore:", e);
                    showModal("Quiz generated successfully, but there was an issue saving it to the database.");
                }
            }

            loadingIndicator.classList.add('hidden');
            generateButton.disabled = false;
        }

        function downloadQuizFile() {
            if (!currentQuiz || currentQuiz.length === 0) {
                showModal("Please generate a quiz first.");
                return;
            }

            const context = topicInput.value.trim() || fileInput.files[0]?.name || "Image Quiz";
            const language = languageSelect.value;
            let fileContent = `# Quiz on: ${context} (${language})\n\n`;

            currentQuiz.forEach((q, index) => {
                fileContent += `### Question ${index + 1}: ${q.question}\n\n`;
                q.options.forEach(option => {
                    fileContent += `- ${option}\n`;
                });
                fileContent += `\n**Answer:** ${q.answer}\n\n`;
            });

            const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Quiz_on_${context.replace(/[^a-z0-9]/gi, '_')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function explainAnswer(question, answer, topic) {
            if (apiKey === "YOUR_GEMINI_API_KEY") {
                showModal("Please provide your Gemini API key in the code. Cannot generate explanation.");
                return;
            }

            showModal("Generating explanation, please wait...");
            
            let payload = {
                contents: [{
                    parts: [{
                        text: `For the topic '${topic}', provide a concise explanation for the following quiz question: '${question}'. Explain why the correct answer is '${answer}'.`
                    }]
                }],
                generationConfig: {
                    temperature: 0.2
                }
            };
            
            try {
                const response = await fetch(quizGenerationUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Explanation API error: ${response.status} ${response.statusText} - ${errorText}`);
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                console.log("Explanation API Result:", result);
                const explanation = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Could not generate an explanation.";
                showModal(explanation);

            } catch (error) {
                console.error("Error generating explanation:", error);
                showModal("Sorry, I couldn't generate an explanation at this time.");
            }
        }

        generateButton.addEventListener('click', generateQuiz);
        downloadQuizButton.addEventListener('click', downloadQuizFile);

        window.onload = initFirebase;
    </script>
</body>
</html>
